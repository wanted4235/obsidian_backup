# üìò –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–∫ –æ—Ç–º–µ–Ω—ã (`CancellationToken`)

## üîπ –ß—Ç–æ —Ç–∞–∫–æ–µ `CancellationToken`?

`CancellationToken` ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –≤ .NET, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π **–¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ –æ—Ç–º–µ–Ω—è—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∏–ª–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**. –û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–∞—Ä–µ —Å `CancellationTokenSource`, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª –æ–± –æ—Ç–º–µ–Ω–µ.

### üí° –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è:
- –ó–∞–¥–∞—á–∞ —Å–∞–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –±—ã–ª –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É.
- –ï—Å–ª–∏ –¥–∞ ‚Äî –æ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–≤–æ—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
- –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ, —á–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ —á–µ—Ä–µ–∑ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π `Thread.Abort()`.

---

## üîß –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å `CancellationToken`?

```csharp
var cts = new CancellationTokenSource();
CancellationToken token = cts.Token;
```

| –ö–ª–∞—Å—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------|
| `CancellationTokenSource` | –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª–∞ –æ–± –æ—Ç–º–µ–Ω–µ |
| `CancellationToken` | –û–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–¥–∞—á—É –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –µ–π "—Å–ª—É—à–∞—Ç—å" –∏–∑–º–µ–Ω–µ–Ω–∏—è |

---

## ‚úÖ –ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å —Ç–æ–∫–µ–Ω –≤ –∑–∞–¥–∞—á—É?

–¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏:

### 1. –ß–µ—Ä–µ–∑ `new Task(...)`
```csharp
var task = new Task(() => LongRunningWork(token), token);
task.Start();
```

### 2. –ß–µ—Ä–µ–∑ `Task.Factory.StartNew(...)`
```csharp
var task = Task.Factory.StartNew(() => LongRunningWork(token), token);
```

### 3. –ß–µ—Ä–µ–∑ `Task.Run(...)`
```csharp
var task = Task.Run(() => LongRunningWork(token), token);
```

> ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Task.Run(...)` ‚Äî –æ–Ω –ø—Ä–æ—â–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ.

---

## üö´ –ü–æ—á–µ–º—É –Ω–µ —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Thread.Abort()`?

- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Ç–æ–∫.
- –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å **—É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏** –∏ **–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤**.
- –ù–µ –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã.

> ‚ö†Ô∏è –í TPL –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ `CancellationToken`**.

---

## üîç –°–ø–æ—Å–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É

### 1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–π—Å—Ç–≤–∞ `IsCancellationRequested`**

–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ü–∏–∫–ª–æ–≤ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π:

```csharp
private static void LongRunningWork(CancellationToken token)
{
    for (int i = 0; i < 1000; i++)
    {
        if (token.IsCancellationRequested)
            token.ThrowIfCancellationRequested();

        Thread.Sleep(50); // –∏–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
    }
}
```

### 2. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ (callback)**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–µ–ª—å–∑—è —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `IsCancellationRequested` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏):

```csharp
token.Register(() => webClient.CancelAsync());
webClient.DownloadStringAsync(new Uri("http://example.com"));
```

---

## üìå –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Å –æ–ø—Ä–æ—Å–æ–º —Ç–æ–∫–µ–Ω–∞

```csharp
private static void CancelTaskViaPoll()
{
    var cts = new CancellationTokenSource();
    var token = cts.Token;

    var task = new Task(() => LongRunningSum(token), token);
    task.Start();

    Console.WriteLine("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Ç–º–µ–Ω—ã...");
    Console.ReadLine();

    cts.Cancel(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ–± –æ—Ç–º–µ–Ω–µ
}

private static void LongRunningSum(CancellationToken token)
{
    for (int i = 0; i < 1000; i++)
    {
        token.ThrowIfCancellationRequested(); // –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ
        Thread.Sleep(100);
    }
}
```

---

## üìå –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Å callback-–æ–º

```csharp
private static void DownloadFileWithToken(CancellationToken token)
{
    var webClient = new WebClient();

    token.Register(() => webClient.CancelAsync());

    webClient.DownloadStringCompleted += (sender, e) =>
    {
        if (e.Cancelled)
            Console.WriteLine("–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞");
        else
            Console.WriteLine("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
    };

    webClient.DownloadStringAsync(new Uri("http://example.com"));
}
```

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É

–ú–æ–∂–Ω–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–º–µ–Ω—É —á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è:

```csharp
var cts = new CancellationTokenSource();
cts.CancelAfter(2000); // –û—Ç–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
```

---

## üß© –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ—Ç–º–µ–Ω—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:

```csharp
var cts1 = new CancellationTokenSource();
var cts2 = new CancellationTokenSource();

var linkedToken = CancellationTokenSource.CreateLinkedTokenSource(cts1.Token, cts2.Token);

Task task = Task.Run(() =>
{
    linkedToken.Token.WaitHandle.WaitOne();
    Console.WriteLine("–û–¥–∏–Ω –∏–∑ —Ç–æ–∫–µ–Ω–æ–≤ –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω!");
}, linkedToken.Token);
```

---

## üõë –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç–º–µ–Ω—É –∑–∞–¥–∞—á–∏?

–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

```csharp
try
{
    await task;
}
catch (OperationCanceledException)
{
    Console.WriteLine("–ó–∞–¥–∞—á–∞ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.");
}
```

–∏–ª–∏

```csharp
if (task.IsCanceled)
    Console.WriteLine("–ó–∞–¥–∞—á–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞");
else if (task.IsFaulted)
    Console.WriteLine("–û—à–∏–±–∫–∞: " + task.Exception.Message);
else
    Console.WriteLine("–†–µ–∑—É–ª—å—Ç–∞—Ç: " + task.Result);
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–º–µ–Ω—ã

| –ú–µ—Ç–æ–¥ | –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã |
|-------|----------------|-------|--------|
| `IsCancellationRequested` | –î–æ–ª–≥–∏–µ —Ü–∏–∫–ª—ã, –≤—ã—á–∏—Å–ª–µ–Ω–∏—è | –ü—Ä–æ—Å—Ç–æ–π, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π | –ù—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä—è—Ç—å |
| `Register(callback)` | –û–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω–µ —Ü–∏–∫–ª–∞, IO | –ì–∏–±–∫–∏–π, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π | –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ |
| `CancelAfter()` | –¢–∞–π–º–∞—É—Ç—ã | –£–¥–æ–±–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–º–µ–Ω—ã | –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ |
| `CreateLinkedTokenSource()` | –ù–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ | –£–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–µ–µ –≤ –æ—Ç–ª–∞–¥–∫–µ |

---

## ‚úÖ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------------|----------|
| –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ThrowIfCancellationRequested()` | –î–ª—è –ø—Ä–æ—Å—Ç–æ–π –∏ —á–∏—Ç–∞–µ–º–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ `OperationCanceledException` | –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ |
| –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `await` –≤–º–µ—Å—Ç–æ `.Wait()` –∏–ª–∏ `.Result` | –ò–∑–±–µ–≥–∞–π—Ç–µ deadlock'–æ–≤ |
| –û—á–∏—â–∞–π—Ç–µ —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ | –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `using` –¥–ª—è `CancellationTokenSource` | –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ |

---

## üìå –ò—Ç–æ–≥

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------------|----------|
| `CancellationTokenSource` | –ò—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É |
| `CancellationToken` | –ü–æ–ª—É—á–∞–µ—Ç –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç —Å–∏–≥–Ω–∞–ª –æ–± –æ—Ç–º–µ–Ω–µ |
| –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏ | –î–æ–±—Ä–æ–≤–æ–ª—å–Ω–∞—è, —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞ |
| –õ—É—á—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ThrowIfCancellationRequested()` |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã | –ß–µ—Ä–µ–∑ `IsCanceled` –∏–ª–∏ `try/catch` |
| –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π: `await task;` |
