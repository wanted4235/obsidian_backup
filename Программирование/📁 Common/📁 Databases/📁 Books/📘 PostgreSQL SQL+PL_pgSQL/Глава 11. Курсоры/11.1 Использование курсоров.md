# üìå –ö–æ–Ω—Å–ø–µ–∫—Ç: –ö—É—Ä—Å–æ—Ä—ã –≤ PL/pgSQL

## üîπ 1. –ß—Ç–æ —Ç–∞–∫–æ–µ –∫—É—Ä—Å–æ—Ä—ã?

**–ö—É—Ä—Å–æ—Ä (CURSOR)** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ SQL-–∑–∞–ø—Ä–æ—Å–∞**.

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ü–∏–∫–ª–∞ `FOR`, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, **–∫—É—Ä—Å–æ—Ä –¥–∞–µ—Ç –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è** –Ω–∞–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ‚Äî –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å, –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫—É—Ä—Å–æ—Ä—ã:
- –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ –Ω–∞–±–æ—Ä–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±–æ—Ä–æ—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏

---

## üîπ 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–æ–≤

–ö—É—Ä—Å–æ—Ä—ã –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω—ã, –∫–æ–≥–¥–∞:
- –ù—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
- –ï—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –¥–∞–Ω–Ω—ã–º
- –¢—Ä–µ–±—É–µ—Ç—Å—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä—ë–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

> üí° –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ü–∏–∫–ª–æ–≤ `FOR`, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç –≤–µ—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–∑—É, –∫—É—Ä—Å–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç **–ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∑–∞ —Ä–∞–∑**, —á—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å.

---

## üîπ 3. –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞

–ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—É—Ä—Å–æ—Ä–∞ –µ–≥–æ –Ω—É–∂–Ω–æ **–æ–±—ä—è–≤–∏—Ç—å** –≤ —Ä–∞–∑–¥–µ–ª–µ `DECLARE`.

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å:
```sql
DECLARE
    –∏–º—è_–∫—É—Ä—Å–æ—Ä–∞ CURSOR [ (–∞—Ä–≥—É–º–µ–Ω—Ç—ã) ] FOR –∑–∞–ø—Ä–æ—Å;
```

–ú–æ–∂–Ω–æ –æ–±—ä—è–≤–∏—Ç—å –∫–∞–∫ **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫—É—Ä—Å–æ—Ä** (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤), —Ç–∞–∫ –∏ **–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π** (—Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏).

### –ü—Ä–∏–º–µ—Ä—ã:

#### a) –ü—Ä–æ—Å—Ç–æ–π –∫—É—Ä—Å–æ—Ä:
```sql
DECLARE
    emp_cursor CURSOR FOR SELECT * FROM employees;
```

#### b) –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å–æ—Ä:
```sql
DECLARE
    dept_cursor CURSOR (d_id INTEGER) FOR
        SELECT * FROM employees WHERE department_id = d_id;
```

üìå –ü–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Äî –æ–Ω –ø—Ä–æ—Å—Ç–æ **–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å**, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ–∑–∂–µ.

---

## üîπ 4. –û—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ **–æ—Ç–∫—Ä—ã—Ç—å**, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –¥–∞–Ω–Ω—ã–º–∏.

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å:
```sql
OPEN –∏–º—è_–∫—É—Ä—Å–æ—Ä–∞ [ (–∞—Ä–≥—É–º–µ–Ω—Ç—ã) ];
```

–ó–∞—Ç–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π `FETCH`.

### –ö–æ–º–∞–Ω–¥—ã `FETCH`:
| –ö–æ–º–∞–Ω–¥–∞                   | –û–ø–∏—Å–∞–Ω–∏–µ                       |
| ------------------------- | ------------------------------ |
| `FETCH NEXT FROM cursor`  | –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É      |
| `FETCH FIRST FROM cursor` | –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É         |
| `FETCH LAST FROM cursor`  | –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É      |
| `FETCH PRIOR FROM cursor` | –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–æ–∫—É     |
| `FETCH ALL FROM cursor`   | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏ |

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR SELECT id, name FROM employees;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;
        RAISE NOTICE 'ID: %, –ò–º—è: %', emp.id, emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå `NOT FOUND` ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `TRUE`, –∫–æ–≥–¥–∞ `FETCH` –Ω–µ –Ω–∞—à—ë–ª –¥–∞–Ω–Ω—ã—Ö.

---

## üîπ 5. –ó–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞

–ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—Å–æ—Ä–æ–º –µ–≥–æ —Å–ª–µ–¥—É–µ—Ç **–∑–∞–∫—Ä—ã—Ç—å**, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã.

### –°–∏–Ω—Ç–∞–∫—Å–∏—Å:
```sql
CLOSE –∏–º—è_–∫—É—Ä—Å–æ—Ä–∞;
```

### –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä:
- –ß—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å –ª–∏—à–Ω—é—é –ø–∞–º—è—Ç—å
- –ß—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π
- –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —É—Ç–µ—á–µ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤

---

## ‚úÖ –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

| –°–æ–≤–µ—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| –ò—Å–ø–æ–ª—å–∑—É–π `NOT FOUND` –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ü–∏–∫–ª–∞ | –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö |
| –ù–µ –∑–∞–±—ã–≤–∞–π –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è | –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ |
| –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–æ—Ä—ã | –î–ª—è –≥–∏–±–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è |
| –°—Ä–∞–≤–Ω–∏ —Å —Ü–∏–∫–ª–æ–º `FOR` | –ß–∞—Å—Ç–æ –ø—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `FOR`, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–±–æ—Ä —Å—Ç—Ä–æ–∫ |

---

## üß© –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

| –≠—Ç–∞–ø | –î–µ–π—Å—Ç–≤–∏–µ |
|------|----------|
| –û–±—ä—è–≤–ª–µ–Ω–∏–µ | `DECLARE cursor_name CURSOR FOR query` |
| –û—Ç–∫—Ä—ã—Ç–∏–µ | `OPEN cursor_name` |
| –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | `FETCH ... FROM cursor_name` |
| –ó–∞–∫—Ä—ã—Ç–∏–µ | `CLOSE cursor_name` |

**–ö—É—Ä—Å–æ—Ä—ã** –¥–∞—é—Ç —Ç–µ–±–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –≤ PL/pgSQL. –û–Ω–∏ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω—ã –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ –Ω–∞–±–æ—Ä–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π.

---
