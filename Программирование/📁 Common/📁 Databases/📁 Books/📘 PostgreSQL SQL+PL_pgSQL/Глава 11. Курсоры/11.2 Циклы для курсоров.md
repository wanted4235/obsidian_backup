# üìå –ö–æ–Ω—Å–ø–µ–∫—Ç: –¶–∏–∫–ª—ã –¥–ª—è –∫—É—Ä—Å–æ—Ä–æ–≤ –≤ PL/pgSQL

## üîπ –í–≤–µ–¥–µ–Ω–∏–µ

–í PL/pgSQL –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Ü–∏–∫–ª—ã —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å –∫—É—Ä—Å–æ—Ä–∞–º–∏**, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞ **–ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –∑–∞ —Ä–∞–∑**. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏:

- –û–±—Ä–∞–±–æ—Ç–∫–µ –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –†–∞–±–æ—Ç–µ —Å —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –ù—É–∂–¥–µ –≤ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã–º–∏

–•–æ—Ç—è –≤ PL/pgSQL –µ—Å—Ç—å —É–¥–æ–±–Ω—ã–µ —Ü–∏–∫–ª—ã `FOR`, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç –∫—É—Ä—Å–æ—Ä–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `FOR record IN SELECT ...`), –Ω–∞—Å—Ç–æ—è—â–∏–µ **–∫—É—Ä—Å–æ—Ä—ã –¥–∞—é—Ç –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è** –Ω–∞–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ–º.

---

## üîÅ –û—Å–Ω–æ–≤–Ω—ã–µ —à–∞–≥–∏ —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—Å–æ—Ä–∞–º–∏ –≤ —Ü–∏–∫–ª–∞—Ö:

1. **–û–±—ä—è–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞**
2. **–û—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞**
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (`FETCH`)**
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ü–∏–∫–ª–µ**
5. **–ó–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞**

---

## üîπ 1. –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤—ã–π —Ü–∏–∫–ª —Å –∫—É—Ä—Å–æ—Ä–æ–º

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR SELECT id, name FROM employees;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp; -- –ø–æ–ª—É—á–∞–µ–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
        EXIT WHEN NOT FOUND; -- –≤—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å

        RAISE NOTICE 'ID: %, –ò–º—è: %', emp.id, emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –≠—Ç–æ—Ç –∫–æ–¥:
- –û–±—ä—è–≤–ª—è–µ—Ç –∫—É—Ä—Å–æ—Ä
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ
- –ß–∏—Ç–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –ø–æ –æ–¥–Ω–æ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `NOT FOUND`, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ü–∏–∫–ª
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã

---

## üîπ 2. –ü—Ä–∏–º–µ—Ä 2: –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å–æ—Ä –≤ —Ü–∏–∫–ª–µ

```sql
DO $$
DECLARE
    emp_cursor CURSOR (dept_id INTEGER) FOR
        SELECT id, name FROM employees WHERE department_id = dept_id;
    emp RECORD;
BEGIN
    OPEN emp_cursor(2); -- –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        RAISE NOTICE 'ID: %, –ò–º—è: %', emp.id, emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –ó–¥–µ—Å—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º **–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å–æ—Ä**, –∫–æ—Ç–æ—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—É.

---

## üîπ 3. –ü—Ä–∏–º–µ—Ä 3: –¶–∏–∫–ª —Å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º –ø–æ –∫—É—Ä—Å–æ—Ä—É (`FETCH NEXT`, `FETCH PRIOR`)

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR SELECT id, name FROM employees ORDER BY id;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    -- –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å
    FETCH NEXT FROM emp_cursor INTO emp;
    WHILE FOUND LOOP
        RAISE NOTICE 'ID: %, –ò–º—è: %', emp.id, emp.name;

        -- –ü–µ—Ä–µ–º–µ—â–∞–µ–º—Å—è –∫ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–ø–∏—Å–∏
        FETCH NEXT FROM emp_cursor INTO emp;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `FETCH NEXT`. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- `FETCH FIRST`
- `FETCH LAST`
- `FETCH PRIOR`

---

## üîπ 4. –ü—Ä–∏–º–µ—Ä 4: –¶–∏–∫–ª —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `FETCH ALL` (–≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏)

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR SELECT id, name FROM employees;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    -- –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å—Ä–∞–∑—É
    FETCH ALL FROM emp_cursor INTO emp;

    WHILE FOUND LOOP
        RAISE NOTICE 'ID: %, –ò–º—è: %', emp.id, emp.name;
        FETCH emp_cursor INTO emp;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå `FETCH ALL` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–∞–∑—É **–≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å—Ç—Ä–æ–∫–∏**, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–ª–æ–∫–∞–º–∏.

---

## üîπ 5. –ü—Ä–∏–º–µ—Ä 5: –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã —Å –∫—É—Ä—Å–æ—Ä–∞–º–∏

```sql
DO $$
DECLARE
    dept_cursor CURSOR FOR SELECT id, name FROM departments;
    emp_cursor CURSOR (d_id INTEGER) FOR
        SELECT id, name FROM employees WHERE department_id = d_id;
    dept RECORD;
    emp RECORD;
BEGIN
    OPEN dept_cursor;

    LOOP
        FETCH dept_cursor INTO dept;
        EXIT WHEN NOT FOUND;

        RAISE NOTICE '–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: %', dept.name;

        OPEN emp_cursor(dept.id);

        LOOP
            FETCH emp_cursor INTO emp;
            EXIT WHEN NOT FOUND;

            RAISE NOTICE '  –°–æ—Ç—Ä—É–¥–Ω–∏–∫: %', emp.name;
        END LOOP;

        CLOSE emp_cursor;
    END LOOP;

    CLOSE dept_cursor;
END $$;
```

üìå –≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã**
- –ö–∞–∫ —Å–≤—è–∑–∞—Ç—å **–∫—É—Ä—Å–æ—Ä—ã –º–µ–∂–¥—É —Å–æ–±–æ–π**
- –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü

---

## üîπ 6. –ü—Ä–∏–º–µ—Ä 6: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ü–∏–∫–ª–µ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–µ–π

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR
        SELECT * FROM employees WHERE salary < 3000 FOR UPDATE;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        UPDATE employees
        SET salary = salary * 1.1
        WHERE CURRENT OF emp_cursor;

        RAISE NOTICE '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ % –ø–æ–≤—ã—à–µ–Ω–∞', emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –ó–¥–µ—Å—å –º—ã:
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—É—Ä—Å–æ—Ä —Å `FOR UPDATE` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫
- –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ `WHERE CURRENT OF`
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º —Ç–æ—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –∫—É—Ä—Å–æ—Ä–∞

---

## ‚úÖ –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

| –°–æ–≤–µ—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| –ò—Å–ø–æ–ª—å–∑—É–π `NOT FOUND` –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ü–∏–∫–ª–∞ | –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö |
| –ù–µ –∑–∞–±—ã–≤–∞–π –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è | –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ |
| –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–æ—Ä—ã | –î–ª—è –≥–∏–±–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è |
| –ò—Å–ø–æ–ª—å–∑—É–π `FOR UPDATE` —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é | –ß—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–∏—à–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ |
| –ò–∑–±–µ–≥–∞–π –≥–ª—É–±–æ–∫–∏—Ö —É—Ä–æ–≤–Ω–µ–π –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ | –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞ |

---

## üß© –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

| –ö–æ–º–∞–Ω–¥–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|------------|
| `OPEN` | –û—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ |
| `FETCH` | –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—É—Ä—Å–æ—Ä–∞ |
| `EXIT WHEN NOT FOUND` | –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å |
| `CLOSE` | –ó–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ |
| `WHERE CURRENT OF` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –∫—É—Ä—Å–æ—Ä–∞ |

**–¶–∏–∫–ª—ã —Å –∫—É—Ä—Å–æ—Ä–∞–º–∏** ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ PL/pgSQL, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

---

