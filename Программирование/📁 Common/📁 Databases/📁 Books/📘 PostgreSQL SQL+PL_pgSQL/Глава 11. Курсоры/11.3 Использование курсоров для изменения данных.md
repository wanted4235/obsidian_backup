# üìå –ö–æ–Ω—Å–ø–µ–∫—Ç: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

## üîπ –í–≤–µ–¥–µ–Ω–∏–µ

–ö—É—Ä—Å–æ—Ä—ã –≤ PL/pgSQL ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ **—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ**, –Ω–æ –∏ **–∏–∑–º–µ–Ω—è—Ç—å –∏—Ö –ø–æ—Å—Ç—Ä–æ—á–Ω–æ**. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∏:

- –û–±—Ä–∞–±–æ—Ç–∫–µ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ç–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è–º–∏

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π `UPDATE` –∏–ª–∏ `DELETE`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –ø–æ –æ–¥–Ω–æ–π
- –ü—Ä–∏–º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–∏–π
- –û–±–Ω–æ–≤–ª—è—Ç—å –∏–ª–∏ —É–¥–∞–ª—è—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É –∫—É—Ä—Å–æ—Ä–∞

---

## üîÅ –û—Å–Ω–æ–≤–Ω—ã–µ —à–∞–≥–∏ —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—Å–æ—Ä–∞–º–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:

1. **–û–±—ä—è–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞**
2. **–û—Ç–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞ (—Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)**
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (`FETCH`)**
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ü–∏–∫–ª–µ**
5. **–ó–∞–∫—Ä—ã—Ç–∏–µ –∫—É—Ä—Å–æ—Ä–∞**

> üí° –ß—Ç–æ–±—ã –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä, –µ–≥–æ –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Å –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º `FOR UPDATE`.

---

## üîπ 1. –ü—Ä–∏–º–µ—Ä: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR
        SELECT * FROM employees WHERE salary < 3000 FOR UPDATE;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        -- –ü–æ–≤—ã—à–∞–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É –Ω–∞ 10%
        UPDATE employees
        SET salary = salary * 1.1
        WHERE CURRENT OF emp_cursor;

        RAISE NOTICE '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ % –ø–æ–≤—ã—à–µ–Ω–∞', emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –ó–¥–µ—Å—å –º—ã:
- –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä —Å `FOR UPDATE`, —á—Ç–æ–±—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏
- –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å —Å –ø–æ–º–æ—â—å—é `WHERE CURRENT OF`
- –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏

---

## üîπ 2. –ü—Ä–∏–º–µ—Ä: –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR
        SELECT * FROM employees WHERE salary < 2000 FOR UPDATE;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        DELETE FROM employees
        WHERE CURRENT OF emp_cursor;

        RAISE NOTICE '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ % —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã', emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –≠—Ç–æ—Ç –∫–æ–¥:
- –í—ã–±–∏—Ä–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –Ω–∏–∑–∫–æ–π –∑–∞—Ä–ø–ª–∞—Ç–æ–π
- –£–¥–∞–ª—è–µ—Ç –∏—Ö –ø–æ –æ–¥–Ω–æ–º—É
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CURRENT OF`, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É –∫—É—Ä—Å–æ—Ä–∞

---

## üîπ 3. –ü—Ä–∏–º–µ—Ä: –£—Å–ª–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR
        SELECT * FROM employees FOR UPDATE;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        IF emp.salary < 2500 THEN
            UPDATE employees
            SET salary = 2500
            WHERE CURRENT OF emp_cursor;

            RAISE NOTICE '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ % —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –º–∏–Ω–∏–º—É–º–∞', emp.name;
        ELSIF emp.salary > 10000 THEN
            UPDATE employees
            SET salary = 10000
            WHERE CURRENT OF emp_cursor;

            RAISE NOTICE '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ % –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –º–∞–∫—Å–∏–º—É–º–æ–º', emp.name;
        END IF;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –ì–∏–±–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
- –ü—Ä–∏–º–µ–Ω—è—Ç—å —Ä–∞–∑–Ω—É—é –ª–æ–≥–∏–∫—É –∫ —Ä–∞–∑–Ω—ã–º —Å—Ç—Ä–æ–∫–∞–º
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–¥–∞

---

## üîπ 4. –ü—Ä–∏–º–µ—Ä: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–æ—Ä–∞

```sql
DO $$
DECLARE
    emp_cursor CURSOR (min_salary NUMERIC) FOR
        SELECT * FROM employees WHERE salary < min_salary FOR UPDATE;
    emp RECORD;
BEGIN
    OPEN emp_cursor(3000);

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        UPDATE employees
        SET salary = salary * 1.1
        WHERE CURRENT OF emp_cursor;

        RAISE NOTICE '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ % –ø–æ–≤—ã—à–µ–Ω–∞', emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –ö—É—Ä—Å–æ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `min_salary`, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –≥–∏–±–∫–∏–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

---

## üîπ 5. –ü—Ä–∏–º–µ—Ä: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Ñ–ª–∞–≥–æ–º –∏ –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏

```sql
ALTER TABLE employees ADD COLUMN last_updated TIMESTAMP;

DO $$
DECLARE
    emp_cursor CURSOR FOR
        SELECT * FROM employees FOR UPDATE;
    emp RECORD;
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        UPDATE employees
        SET salary = salary * 1.05,
            last_updated = NOW()
        WHERE CURRENT OF emp_cursor;

        RAISE NOTICE '–î–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ % –æ–±–Ω–æ–≤–ª–µ–Ω—ã', emp.name;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –ó–¥–µ—Å—å:
- –ú—ã –¥–æ–±–∞–≤–∏–ª–∏ –∫–æ–ª–æ–Ω–∫—É `last_updated`
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—è `salary` —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

---

## ‚úÖ –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

| –°–æ–≤–µ—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| –ò—Å–ø–æ–ª—å–∑—É–π `FOR UPDATE` | –ß—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∏–ª–∏ —É–¥–∞–ª—è—Ç—å —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä |
| –ò—Å–ø–æ–ª—å–∑—É–π `WHERE CURRENT OF` | –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å |
| –ù–µ –∑–∞–±—ã–≤–∞–π –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã | –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ |
| –î–æ–±–∞–≤–ª—è–π –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `RAISE NOTICE` | –ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã |
| –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–æ—Ä—ã | –î–ª—è –≥–∏–±–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è |

---

## üß© –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `FOR UPDATE` | –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä |
| `WHERE CURRENT OF` | –¢–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ |
| `FETCH` | –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç—Ä–æ—á–Ω–æ |
| `LOOP` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ |
| `PARAMETERIZED CURSORS` | –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ |

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ‚Äî –º–æ—â–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –≤ PL/pgSQL, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–æ–π.

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–±–µ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏** –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä—ã –∏–ª–∏ –ø–æ–º–æ—á—å –Ω–∞–ø–∏—Å–∞—Ç—å —Ö—Ä–∞–Ω–∏–º—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—É—Ä—Å–æ—Ä–æ–≤.