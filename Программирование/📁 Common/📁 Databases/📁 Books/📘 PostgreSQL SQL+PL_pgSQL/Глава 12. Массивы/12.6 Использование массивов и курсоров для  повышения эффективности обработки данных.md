# üìå –ö–æ–Ω—Å–ø–µ–∫—Ç: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤ –∏ –∫—É—Ä—Å–æ—Ä–æ–≤ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

## üîπ –í–≤–µ–¥–µ–Ω–∏–µ

–ú–∞—Å—Å–∏–≤—ã –∏ –∫—É—Ä—Å–æ—Ä—ã ‚Äî –¥–≤–∞ –º–æ—â–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —è–∑—ã–∫–∞ **PL/pgSQL**, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –≥–∏–±–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–º–∏. –ò—Ö —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Å–µ—Ä–≤–µ—Ä—É
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç–∞–º–∏, –∞ –Ω–µ –ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
- –°–Ω–∏–∂–∞—Ç—å —Å–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## üîÅ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–æ–≤ –∏ –∫—É—Ä—Å–æ—Ä–æ–≤ –≤–º–µ—Å—Ç–µ:

| –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------------|----------|
| **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö** | –ú–∞—Å—Å–∏–≤—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–ª—å—à–∏–º–∏ –æ–±—ä—ë–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö** | –ö—É—Ä—Å–æ—Ä—ã –¥–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏ |
| **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î** | –ü–æ–∑–≤–æ–ª—è–µ—Ç –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É SQL –∏ PL/pgSQL |
| **–ì–∏–±–∫–æ—Å—Ç—å** | –ú–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫ –∫–∞–∂–¥–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É |

---

## üî∏ –ü—Ä–∏–º–µ—Ä 1: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –≤ –º–∞—Å—Å–∏–≤

```sql
DO $$
DECLARE
    names TEXT[];
BEGIN
    SELECT array_agg(name) INTO names FROM employees;

    RAISE NOTICE '–°–ø–∏—Å–æ–∫ –∏–º—ë–Ω: %', names;
END $$;
```

üìå –ó–¥–µ—Å—å:
- –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `array_agg()` –¥–ª—è —Å–±–æ—Ä–∫–∏ —Å—Ç–æ–ª–±—Ü–∞ –≤ –º–∞—Å—Å–∏–≤
- –î–∞–ª–µ–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤ –≤ —Ü–∏–∫–ª–µ –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –≤ –¥—Ä—É–≥—É—é —Ñ—É–Ω–∫—Ü–∏—é

---

## üî∏ –ü—Ä–∏–º–µ—Ä 2: –ü–µ—Ä–µ–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –º–∞—Å—Å–∏–≤

```sql
DO $$
DECLARE
    emp_cursor REFCURSOR := 'mycursor';
    result_array TEXT[];
    emp RECORD;
BEGIN
    OPEN emp_cursor FOR SELECT name FROM employees WHERE salary > 5000;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        result_array := array_append(result_array, emp.name);
    END LOOP;

    CLOSE emp_cursor;

    RAISE NOTICE '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –∑–∞—Ä–ø–ª–∞—Ç–æ–π >5000: %', result_array;
END $$;
```

üìå –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø–æ–ª–µ–∑–µ–Ω, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:
- –í—ã–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üî∏ –ü—Ä–∏–º–µ—Ä 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–ø–∏—Å–∫—É ID —á–µ—Ä–µ–∑ –º–∞—Å—Å–∏–≤

```sql
DO $$
DECLARE
    ids INTEGER[] := ARRAY[1, 2, 3];
    i INTEGER;
BEGIN
    FOREACH i IN ARRAY ids LOOP
        UPDATE employees
        SET salary = salary * 1.1
        WHERE id = i;
    END LOOP;

    RAISE NOTICE '–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Å ID % –ø–æ–≤—ã—à–µ–Ω–∞', ids;
END $$;
```

üìå –≠—Ç–æ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —á–µ–º:
```sql
UPDATE employees SET salary = salary * 1.1 WHERE id IN (1, 2, 3);
```
–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞.

---

## üî∏ –ü—Ä–∏–º–µ—Ä 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä –∏ –º–∞—Å—Å–∏–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR SELECT * FROM employees FOR UPDATE;
    emp RECORD;
    high_salary_ids INTEGER[];
BEGIN
    OPEN emp_cursor;

    LOOP
        FETCH emp_cursor INTO emp;
        EXIT WHEN NOT FOUND;

        IF emp.salary > 10000 THEN
            high_salary_ids := array_append(high_salary_ids, emp.id);
            CONTINUE;
        END IF;

        -- –ü–æ–≤—ã—à–∞–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–∏–∂–µ 10000
        UPDATE employees
        SET salary = salary * 1.1
        WHERE CURRENT OF emp_cursor;
    END LOOP;

    CLOSE emp_cursor;

    RAISE NOTICE '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –≤—ã—Å–æ–∫–æ–π –∑–∞—Ä–ø–ª–∞—Ç–æ–π: %', high_salary_ids;
END $$;
```

üìå –ó–¥–µ—Å—å –º—ã:
- –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (`FOR UPDATE`)
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è `salary`
- –ï—Å–ª–∏ –æ–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º ID –≤ –º–∞—Å—Å–∏–≤
- –ò–Ω–∞—á–µ ‚Äî –ø–æ–≤—ã—à–∞–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É

---

## üî∏ –ü—Ä–∏–º–µ—Ä 5: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ä—Ü–∏—è–º–∏ —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä –∏ –º–∞—Å—Å–∏–≤

```sql
DO $$
DECLARE
    emp_cursor CURSOR FOR SELECT id, name FROM employees ORDER BY id;
    batch_size CONSTANT INTEGER := 5;
    emp RECORD;
    id_batch INTEGER[];
    name_batch TEXT[];
BEGIN
    OPEN emp_cursor;

    LOOP
        id_batch := ARRAY[]::INTEGER[];
        name_batch := ARRAY[]::TEXT[];

        FOR i IN 1..batch_size LOOP
            FETCH emp_cursor INTO emp;
            EXIT WHEN NOT FOUND;

            id_batch := array_append(id_batch, emp.id);
            name_batch := array_append(name_batch, emp.name);
        END LOOP;

        EXIT WHEN array_length(id_batch, 1) = 0;

        RAISE NOTICE '–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –ø–æ—Ä—Ü–∏—è: IDs=%, Names=%', id_batch, name_batch;
    END LOOP;

    CLOSE emp_cursor;
END $$;
```

üìå –≠—Ç–æ—Ç –∫–æ–¥:
- –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ü–∏—è–º–∏ –ø–æ 5 —Å—Ç—Ä–æ–∫
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ –º–∞—Å—Å–∏–≤—ã
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –ø–∞–∫–µ—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É, –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç.–¥.

---

## üî∏ –ü—Ä–∏–º–µ—Ä 6: –ü–µ—Ä–µ–¥–∞—á–∞ –º–∞—Å—Å–∏–≤–∞ –≤ —Ñ—É–Ω–∫—Ü–∏—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –∫—É—Ä—Å–æ—Ä

```sql
CREATE OR REPLACE FUNCTION get_employees_by_ids(emp_ids INTEGER[])
RETURNS TABLE(id INTEGER, name TEXT, salary NUMERIC) AS $$
DECLARE
    refcur REFCURSOR := 'emp_cursor';
BEGIN
    OPEN refcur FOR EXECUTE
        'SELECT id, name, salary FROM employees WHERE id = ANY($1)'
        USING emp_ids;

    RETURN QUERY
    SELECT * FROM emp_cursor;
END;
$$ LANGUAGE plpgsql;
```

üìå –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏:
```sql
SELECT * FROM get_employees_by_ids(ARRAY[1, 2, 3]);
```

üìå –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ:
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ ID
- –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫—É—Ä—Å–æ—Ä –∏–ª–∏ –Ω–∞–±–æ—Ä —Å—Ç—Ä–æ–∫

---

## ‚úÖ –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã

| –°–æ–≤–µ—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| –ò—Å–ø–æ–ª—å–∑—É–π `array_agg` –∏ `unnest` –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö | –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –º–∞—Å—Å–∏–≤–∞–º–∏ |
| –ù–µ –∑–∞–±—ã–≤–∞–π –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã | –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ |
| –ò—Å–ø–æ–ª—å–∑—É–π `FOREACH` –¥–ª—è –ø–µ—Ä–µ–±–æ—Ä–∞ –º–∞—Å—Å–∏–≤–æ–≤ | –û–Ω —á–∏—Ç–∞–±–µ–ª—å–Ω–µ–µ –∏ –ø—Ä–æ—â–µ |
| –†–∞–∑–¥–µ–ª—è–π –±–æ–ª—å—à–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –ø–æ—Ä—Ü–∏–∏ | –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î |
| –ò—Å–ø–æ–ª—å–∑—É–π `WHERE CURRENT OF` –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫—É—Ä—Å–æ—Ä–∞–º–∏ | –ß—Ç–æ–±—ã —Ç–æ—á–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É |

---

## üß© –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç         | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å                             |
| ------------------ | ---------------------------------------------- |
| `array_agg()`      | –î–ª—è —Å–±–æ—Ä–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ –º–∞—Å—Å–∏–≤                   |
| `unnest()`         | –î–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ –≤ —Å—Ç—Ä–æ–∫–∏            |
| `FOREACH`          | –î–ª—è –ø–µ—Ä–µ–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞                 |
|  –ö—É—Ä—Å–æ—Ä—ã           | –î–ª—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö                |
| `REFCURSOR`        | –î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∫—É—Ä—Å–æ—Ä–∞ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏           |
| `WHERE CURRENT OF` | –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ –∫—É—Ä—Å–æ—Ä–∞ |

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤ –∏ –∫—É—Ä—Å–æ—Ä–æ–≤ –≤ PL/pgSQL ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–≤—ã—Å–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä—ë–º–∞–º–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –û–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.

---
