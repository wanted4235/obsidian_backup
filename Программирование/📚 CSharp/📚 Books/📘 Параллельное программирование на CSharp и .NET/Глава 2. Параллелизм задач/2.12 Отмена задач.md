# üìò –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á –≤ TPL (.NET)

## üîπ –í–≤–µ–¥–µ–Ω–∏–µ

–û–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ Task Parallel Library (TPL) —è–≤–ª—è–µ—Ç—Å—è **–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏.

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ —Å –ø–æ—Ç–æ–∫–∞–º–∏ (`Thread`), –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è—é—â–µ–≥–æ—Å—è –ø–æ—Ç–æ–∫–∞ ‚Äî —Å–ª–æ–∂–Ω–∞—è –∏ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –≤ TPL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–º–µ—Ö–∞–Ω–∏–∑–º –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ–π –æ—Ç–º–µ–Ω—ã —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω—ã**.

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Ç–º–µ–Ω—ã:

| –ö–ª–∞—Å—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------|
| `CancellationTokenSource` | –ò—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É. –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∏ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–∏–≥–Ω–∞–ª –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º. |
| `CancellationToken` | –û–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π "—Å–ª—É—à–∞–µ—Ç" –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è. –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–¥–∞—á–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –Ω–∏—Ö. |

### üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –°–æ–∑–¥–∞—ë—Ç—Å—è `CancellationTokenSource`.
2. –ß–µ—Ä–µ–∑ –µ–≥–æ —Å–≤–æ–π—Å—Ç–≤–æ `.Token` –ø–æ–ª—É—á–∞–µ–º `CancellationToken`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–¥–∞—á—É.
3. –ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `.Cancel()`, –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—É—á–∞—é—Ç —Å–∏–≥–Ω–∞–ª –æ–± –æ—Ç–º–µ–Ω–µ.
4. –ó–∞–¥–∞—á–∞ —Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç, –∫–∞–∫ –Ω–∞ –Ω–µ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è).

---

## ‚úÖ –ü–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –æ—Ç–º–µ–Ω—ã:
```csharp
var cts = new CancellationTokenSource();
CancellationToken token = cts.Token;
```

### 2. –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–¥–∞—á—É:
```csharp
Task task = Task.Run(() =>
{
    for (int i = 0; i < 100; i++)
    {
        token.ThrowIfCancellationRequested(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É
        Console.WriteLine($"–†–∞–±–æ—Ç–∞—é... {i}");
        Thread.Sleep(100);
    }
}, token); // –ü–µ—Ä–µ–¥–∞—ë–º —Ç–æ–∫–µ–Ω
```

### 3. –í—ã–∑–æ–≤ –æ—Ç–º–µ–Ω—ã:
```csharp
cts.Cancel(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ–± –æ—Ç–º–µ–Ω–µ
```

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
```csharp
try
{
    task.Wait(); // –∏–ª–∏ await task;
}
catch (AggregateException ae)
{
    if (ae.InnerException is TaskCanceledException)
    {
        Console.WriteLine("–ó–∞–¥–∞—á–∞ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.");
    }
}
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å

- **–û—Ç–º–µ–Ω–∞ –Ω–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è** ‚Äî –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ —Å–∞–º–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
- –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω, –æ–Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `Cancel()`.
- –ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á, –∏—Å–ø–æ–ª—å–∑—É—è –æ–¥–∏–Ω `CancellationTokenSource`.

---

## üìå –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–¥–∞—á —Å –æ–¥–Ω–∏–º —Ç–æ–∫–µ–Ω–æ–º

```csharp
var cts = new CancellationTokenSource();

Task task1 = Task.Run(() => Work(cts.Token), cts.Token);
Task task2 = Task.Run(() => Work(cts.Token), cts.Token);

// –û—Ç–º–µ–Ω–∏—Ç—å –æ–±–µ –∑–∞–¥–∞—á–∏
cts.Cancel();
```

---

## üîÑ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞?

–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á–∏:

```csharp
if (task.IsCanceled)
{
    Console.WriteLine("–ó–∞–¥–∞—á–∞ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞");
}
else if (task.IsFaulted)
{
    Console.WriteLine("–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π");
}
else if (task.IsCompleted)
{
    Console.WriteLine("–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
}
```

---

## üõë –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `.Cancel()`?

- –í—Å–µ –∑–∞–¥–∞—á–∏, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º —Ç–æ–∫–µ–Ω–æ–º, –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
- –ï—Å–ª–∏ –æ–Ω–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ `ThrowIfCancellationRequested()`, —Ç–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `OperationCanceledException`.
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ `AggregateException`, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `.Wait()` –∏–ª–∏ `Task.Exception`.

---

## üß© –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `cts.CancelAfter(milliseconds)` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–ª–±—ç–∫–æ–≤ | `token.Register(() => { /* –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ */ })` |
| –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ | `var linkedToken = CancellationTokenSource.CreateLinkedTokenSource(token1, token2)` |

---

## üß† –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

| –°–∏—Ç—É–∞—Ü–∏—è | –°–æ–≤–µ—Ç |
|----------|--------|
| –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ –∑–∞–¥–∞—á–µ | –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `token.IsCancellationRequested` –∏–ª–∏ `ThrowIfCancellationRequested()` |
| –ù–µ –±–ª–æ–∫–∏—Ä—É–π—Ç–µ –ø–æ—Ç–æ–∫–∏ —á–µ—Ä–µ–∑ `.Wait()` –∏–ª–∏ `.Result` –±–µ–∑ try/catch | –ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å `AggregateException` |
| –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `await task;` –≤–º–µ—Å—Ç–æ `.Wait()` | –ë–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± |
| –û—á–∏—â–∞–π—Ç–µ —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ | –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã |
| –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `using` –¥–ª—è `CancellationTokenSource` | –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ |

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –æ—Ç–º–µ–Ω—ã

| –ú–µ—Ç–æ–¥ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–º–µ–Ω—É? | –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä—É—á–Ω—É—é? | –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É? |
|-------|------------------------|----------------------------|-------------------------|
| `CancellationToken` + `ThrowIfCancellationRequested()` | ‚úÖ –î–∞ | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç (–¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞) |
| `Thread.Abort()` (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π) | ‚ùå –ù–µ—Ç | ‚Äî | ‚úÖ –î–∞ (–Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å) |
| `Task.FromCanceled()` | ‚úÖ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | ‚Äî | ‚úÖ –ó–∞–¥–∞—á–∞ —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω–∞ |

---

## ‚úÖ –ò—Ç–æ–≥

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------------|----------|
| `CancellationTokenSource` | –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª–∞ –æ–± –æ—Ç–º–µ–Ω–µ |
| `CancellationToken` | –ü–æ–ª—É—á–∞–µ—Ç –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç —Å–∏–≥–Ω–∞–ª –æ–± –æ—Ç–º–µ–Ω–µ |
| –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏ | –î–æ–±—Ä–æ–≤–æ–ª—å–Ω–∞—è, —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞ |
| –õ—É—á—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ThrowIfCancellationRequested()` |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã | –ß–µ—Ä–µ–∑ `IsCanceled` –∏–ª–∏ `try/catch` |
| –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π: `await task;` |

---
