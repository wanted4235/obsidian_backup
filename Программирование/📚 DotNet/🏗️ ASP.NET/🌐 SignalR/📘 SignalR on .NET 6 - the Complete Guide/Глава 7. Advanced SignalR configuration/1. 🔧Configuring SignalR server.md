Для создания расширенной настройки SignalR сервера, требуется в Program.cs добавить namespace:

```C#
using Microsoft.AspNetCore.Http.Connections;
using System.Text.Json.Serialization;
```

# **Три уровня конфигурации SignalR на сервере**

При разработке приложений с использованием **ASP.NET SignalR (или ASP.NET Core SignalR)**, существует **три основных уровня настройки**, которые позволяют управлять поведением и параметрами работы серверной части SignalR. Эти уровни включают:

1. **Top-level SignalR Configuration (Общая глобальная настройка SignalR)**
2. **Message Protocol Configuration (Настройка протокола обмена сообщениями)**
3. **HTTP Transport Configuration (Настройка транспортного уровня HTTP)**

Рассмотрим каждый из них подробно.

---

## 1. **Top-Level SignalR Configuration (Глобальная настройка SignalR)**

Этот уровень отвечает за **общие параметры всей SignalR-инфраструктуры** в приложении. Он применяется ко всем хабам и подключениям.

### Основные параметры:
- Время ожидания подключения
- Настройки трассировки и логирования
- Поведение клиентских повторных подключений
- Обработка событиий жизненного цикла подключения

### Пример настройки (в .NET 6+):

```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddSignalR(options =>
{
    options.ClientTimeoutInterval = TimeSpan.FromSeconds(30); // время бездействия клиента
    options.HandshakeTimeout = TimeSpan.FromSeconds(15);       // время ожидания рукопожатия
    options.KeepAliveInterval = TimeSpan.FromSeconds(10);      // интервал keep-alive
    options.EnableDetailedErrors = true;                       // детализация ошибок
});
```

### Ключевые параметры:
| Параметр | Описание |
|----------|----------|
| `ClientTimeoutInterval` | Максимальное время бездействия клиента, после которого он считается отключённым |
| `HandshakeTimeout` | Максимальное время ожидания успешного установления соединения |
| `KeepAliveInterval` | Частота отправки "пингов" для сохранения соединения |
| `EnableDetailedErrors` | Включает/выключает детальные сообщения об ошибках для клиента (полезно при отладке) |

> Эти параметры влияют на **все клиентские подключения** и задаются один раз при регистрации SignalR в приложении.

---

## 2. **Message Protocol Configuration (Настройка протокола сообщений)**

Этот уровень определяет, **как данные сериализуются и передаются между клиентом и сервером**. SignalR использует **протоколы обмена сообщениями**, например, JSON, MessagePack и др.

### Возможности:
- Выбор формата данных (JSON по умолчанию)
- Поддержка пользовательских форматов
- Настройка параметров сериализации

### Пример: использование MessagePack вместо JSON

```csharp
builder.Services.AddSignalR()
    .AddJsonProtocol(options => 
    {
        options.PayloadSerializerOptions.WriteIndented = true; // красивый JSON
    })
    .AddMessagePackProtocol(); // добавляем MessagePack
```

### Поддерживаемые протоколы:
| Протокол | Описание |
|---------|----------|
| `JSON` | По умолчанию используется в SignalR, легко читать, но менее эффективен по размеру |
| `MessagePack` | Бинарный компактный формат, быстрее и легче JSON |
| `Custom Protocols` | Возможность реализовать свой протокол через `IHubProtocolResolver` |

> Протокол выбирается **на стороне клиента**, и должен быть доступен и на сервере.

---

## 3. **HTTP Transport Configuration (Настройка транспорта)**

Этот уровень связан с **тем, как именно данные передаются между клиентом и сервером по сети**. SignalR поддерживает несколько транспортов и автоматически выбирает лучший доступный.

### Доступные транспорты:
| Тип транспорта | Описание |
|----------------|----------|
| `WebSockets` | Самый современный и эффективный метод, позволяет двустороннюю связь |
| `Server-Sent Events (SSE)` | Односторонняя передача данных с сервера на клиент |
| `Long Polling` | Совместимый с любыми браузерами и прокси, но менее производительный |

### Пример: ограничение используемых транспортов

```csharp
app.UseEndpoints(endpoints =>
{
    endpoints.MapHub<ChatHub>("/chatHub", options =>
    {
        options.Transports = HttpTransportType.WebSockets | HttpTransportType.LongPolling;
    });
});
```

### Другие параметры транспорта:
- `TransferMode`: `Text` или `Binary`
- Настройка логики переподключения
- Управление таймаутами транспорта

---

## Сводная таблица

| Уровень настройки | Отвечает за | Примеры настроек |
|-------------------|-------------|------------------|
| **Top-level** | Глобальное поведение SignalR | Timeout, KeepAlive, ошибки |
| **Message Protocol** | Формат и способ передачи данных | JSON, MessagePack |
| **HTTP Transport** | Способ физической передачи данных | WebSockets, Long Polling |

---

## Заключение

Каждый из трёх уровней настройки SignalR решает свою задачу:
- **Top-level** — управляет общим поведением SignalR.
- **Message Protocol** — отвечает за формат данных.
- **Transport** — за сетевую передачу информации.