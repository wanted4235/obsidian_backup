## üß† –ß—Ç–æ —Ç–∞–∫–æ–µ `TaskScheduler`?

**`TaskScheduler`** ‚Äî —ç—Ç–æ –∫–ª–∞—Å—Å –≤ .NET, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ **–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á (`Task`)**. –ú–æ–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ –∫–∞–∫ "–¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞", –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∞–µ—Ç, **–∫–∞–∫ –∏ –∫–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**.

### üîç –û—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–¥–∞—á–∏ (–æ–±—ä–µ–∫—Ç—ã `Task`)
- –†–µ—à–∞–µ—Ç, **–≤ –∫–∞–∫–æ–º –ø–æ—Ç–æ–∫–µ** –∏ **–∫–æ–≥–¥–∞** –∏—Ö –≤—ã–ø–æ–ª–Ω—è—Ç—å
- –ú–æ–∂–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫—É —Å—Ä–µ–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, UI-–ø–æ—Ç–æ–∫ –≤ Windows Forms –∏–ª–∏ WPF)

---

## üèóÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç TaskScheduler?

–ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä—É—é —Ç—ã —Å–æ–∑–¥–∞–µ—à—å —á–µ—Ä–µ–∑ `Task.Run`, `Task.Factory.StartNew` –∏–ª–∏ `async/await`, **–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø–æ–º–æ—â—å—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `TaskScheduler`**.

### 1. **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ThreadPoolTaskScheduler`, –∫–æ—Ç–æ—Ä—ã–π:
- –ü–µ—Ä–µ–¥–∞—ë—Ç –∑–∞–¥–∞—á–∏ –ø—É–ª—É –ø–æ—Ç–æ–∫–æ–≤ (`ThreadPool`)
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ—Å—É—Ä—Å–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

–≠—Ç–æ —Ç–æ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ç—ã –ø–∏—à–µ—à—å:

```csharp
Task task = Task.Run(() => Console.WriteLine("Hello from background thread"));
```

–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `await someTask;`

---

### 2. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (SynchronizationContext)**
–ï—Å–ª–∏ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ UI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, WPF –∏–ª–∏ Windows Forms), —Ç–æ `TaskScheduler.Default` **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `await`**. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π `SynchronizationContext`.

–ü—Ä–∏–º–µ—Ä:
```csharp
private async void button_Click(...)
{
    await Task.Run(() => DoWork());
    // –ü–æ—Å–ª–µ await –º—ã –≤–µ—Ä–Ω—ë–º—Å—è –≤ UI-–ø–æ—Ç–æ–∫
    label.Text = "Done"; // –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ!
}
```

–ó–¥–µ—Å—å –ø–æ—Å–ª–µ `await` –∑–∞–¥–∞—á–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤ **UI-–ø–æ—Ç–æ–∫–µ**, –ø–æ—Ç–æ–º—É —á—Ç–æ `await` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π `TaskScheduler`, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

> üí° –≠—Ç–æ –≤–∞–∂–Ω–æ: –µ—Å–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ –≤—ã–∑–æ–≤–µ—à—å `.Wait()` –∏–ª–∏ `.Result`, —Ç—ã **–Ω–µ –≤–µ—Ä–Ω—ë—à—å—Å—è –≤ UI-–ø–æ—Ç–æ–∫**, –∏ –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å UI –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—é.

---

## üì¶ –ö–∞–∫–∏–µ –µ—â—ë –µ—Å—Ç—å TaskSchedulers?

–í .NET –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π `TaskScheduler`. –í–æ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ:

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| **`TaskScheduler.Default`** | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ThreadPool`. –°–∞–º—ã–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç. |
| **`TaskScheduler.FromCurrentSynchronizationContext()`** | –°–æ–∑–¥–∞—ë—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ UI-–ø–æ—Ç–æ–∫–µ). |
| **`ConcurrentExclusiveSchedulerPair`** | –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ä—É –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏. –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ Reader-Writer. |
| **`LimitedConcurrencyLevelTaskScheduler`** | –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã—Ö –∑–∞–¥–∞—á. |

---

## üõ† –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TaskScheduler –Ω–∞–ø—Ä—è–º—É—é?

–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π `TaskScheduler` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:

```csharp
var uiScheduler = TaskScheduler.FromCurrentSynchronizationContext();

Task task = Task.Factory.StartNew(() =>
{
    // –≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ ThreadPool
}, CancellationToken.None, TaskCreationOptions.None, uiScheduler)
.ContinueWith(t => 
{
    // –ê —ç—Ç–æ—Ç ‚Äî —É–∂–µ –≤ UI-–ø–æ—Ç–æ–∫–µ
    label.Text = "–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!";
}, uiScheduler);
```

---

## üéØ –ó–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–µ–Ω TaskScheduler?

- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏**: –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å, –≥–¥–µ –∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞–¥–∞—á–∏.
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ UI-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —á–∞—Å—Ç—å –∫–æ–¥–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ UI-–ø–æ—Ç–æ–∫–µ.
- **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π `TaskScheduler` –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω—É–∂–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è GPU-–≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏–ª–∏ —Ä–∞–±–æ—Ç—ã —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º).

---

## üß™ –ö–æ–≥–¥–∞ —Å—Ç–æ–∏—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ TaskScheduler?

- –ï—Å–ª–∏ —Ç—ã –ø–∏—à–µ—à—å **–±–∏–±–ª–∏–æ—Ç–µ–∫—É**, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ UI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ **–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —Å—Ç–µ–ø–µ–Ω—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞**.
- –ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º –ø–æ—Ç–æ–∫–µ**.
- –ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ **–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫** –∏–ª–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤.

---

## üìå –ü—Ä–∏–º–µ—Ä: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FromCurrentSynchronizationContext()

```csharp
private async void button1_Click(object sender, EventArgs e)
{
    var uiScheduler = TaskScheduler.FromCurrentSynchronizationContext();

    await Task.Run(() =>
    {
        // –§–æ–Ω–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞
    });

    // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤ UI-–ø–æ—Ç–æ–∫–µ
    await Task.Factory.StartNew(() =>
    {
        label1.Text = "–û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ TaskScheduler";
    }, CancellationToken.None, TaskCreationOptions.None, uiScheduler);
}
```

---

## üßµ –°–≤—è–∑—å —Å SynchronizationContext

- `TaskScheduler` —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `SynchronizationContext` –¥–ª—è –º–∞—Ä—à–∞–ª–∏–Ω–≥–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ UI-–ø–æ—Ç–æ–∫.
- –í –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –∏ ASP.NET `SynchronizationContext` –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–≤–µ–Ω `null`.
- –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É **–≤–∞–∂–Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–∏ —á–µ—Ä–µ–∑ `.Result` –∏–ª–∏ `.Wait()` –≤ UI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö**, –∏–Ω–∞—á–µ –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø–æ–ª—É—á–∏—Ç—å deadlock.

---

## ‚úÖ –ö—Ä–∞—Ç–∫–∏–π –∏—Ç–æ–≥:

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------------|----------|
| **–ß—Ç–æ —ç—Ç–æ?** | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–¥–∞—á |
| **–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?** | –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏ –æ–∂–∏–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á |
| **–ö–∞–∫–∏–µ —Ç–∏–ø—ã?** | `Default`, UI-—Å–≤—è–∑–∞–Ω–Ω—ã–π, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ |
| **–î–ª—è —á–µ–≥–æ?** | –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ—Ç–æ–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ UI |
| **–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å?** | –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –º–µ—Å—Ç–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á |
